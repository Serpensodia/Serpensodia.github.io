<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Momentum – Leaderboard</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #fafafa;
  color: #111;
  max-width: 420px;
  margin: auto;
  padding: 20px;
}

h1 {
  text-align: center;
}

.toggle {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.toggle button {
  flex: 1;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ddd;
  background: white;
  cursor: pointer;
}

.toggle button.active {
  background: #000;
  color: white;
}

.card {
  background: white;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;

  cursor: pointer;
  transition: transform 0.08s ease, box-shadow 0.12s ease;
}
  .card:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.06);
}

.badge {
  font-weight: 700;
  margin-right: 8px;
}

.fade-in {
  animation: fadeIn 160ms ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(3px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Modal */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
  z-index: 9999;
}

.modal.open { display: flex; }

.modal-box {
  width: 100%;
  max-width: 520px;
  background: #fff;
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 18px 60px rgba(0,0,0,0.18);
}

.modal-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 10px;
}

.modal-title {
  font-size: 18px;
  font-weight: 800;
}

.modal-close {
  border: 1px solid #ddd;
  background: #fff;
  border-radius: 10px;
  padding: 8px 10px;
  cursor: pointer;
}

.modal-close:hover { background: #f5f5f5; }

.history {
  max-height: 60vh;
  overflow: auto;
  padding-right: 4px;
}

.entry {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #eee;
  margin-bottom: 8px;
}

.entry .meta { color: #666; font-size: 13px; }
.entry .pts  { font-weight: 800; }

.pills {
  display: flex;
  gap: 6px;
  margin-top: 4px;
  flex-wrap: wrap;
}

.pill {
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid #eee;
  background: #fafafa;
}


  
</style>
</head>

<body>

<h1>Leaderboard</h1>
<p style="text-align:center;margin-top:-10px;">
  <a href="index.html">← Back to Check-In</a>
</p>

<div class="toggle">
  <button id="dayBtn" onclick="loadLeaderboard('day')">Today</button>
  <button id="weekBtn" class="active" onclick="loadLeaderboard('week')">This Week</button>
  <button id="allBtn" onclick="loadLeaderboard('all')">All Time</button>
</div>
<p id="subtitle" style="text-align:center;color:#666;margin-top:-4px;"></p>

<div id="list"></div>

  <!-- Player History Modal -->
<div id="modal" class="modal">
  <div class="modal-box fade-in">
    <div class="modal-head">
      <div id="modalTitle" class="modal-title">Player History</div>
      <button class="modal-close" onclick="closeModal()">Close</button>
    </div>
    <div id="modalBody" class="history"></div>
  </div>
</div>

<script>
let rows = [];
let headerIndex = {};

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzvi4M8O6393Lzif6_XyzikHnLr996ynxG3mIcG9-CITWa8hbKeuK-G0MhjVJFxzenkUQ/exec"; // same one you use for saving

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

function getMondayStart(d) {
  const x = new Date(d);
  x.setHours(0,0,0,0);
  const day = x.getDay(); // Sun=0
  const diff = (day === 0 ? -6 : 1 - day);
  x.setDate(x.getDate() + diff);
  return x;
}

function parseLocalDate(value) {
  if (!value) return null;

  // If Apps Script returned a Date object
  if (Object.prototype.toString.call(value) === "[object Date]" && !isNaN(value.getTime())) {
    return new Date(value.getFullYear(), value.getMonth(), value.getDate(), 0, 0, 0, 0);
  }

  // If it's a string like "Fri Dec 12 2025 ..."
  const d1 = new Date(value);
  if (!isNaN(d1.getTime())) {
    return new Date(d1.getFullYear(), d1.getMonth(), d1.getDate(), 0, 0, 0, 0);
  }

  // If it's "YYYY-MM-DD"
  const s = String(value).trim();
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
  if (!m) return null;
  return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]), 0, 0, 0, 0);
}

function loadLeaderboard(mode) {
  document.getElementById("weekBtn").classList.toggle("active", mode === "week");
  document.getElementById("allBtn").classList.toggle("active", mode === "all");
  document.getElementById("dayBtn").classList.toggle("active", mode === "day");
const subtitle = document.getElementById("subtitle");

if (mode === "day") {
  subtitle.textContent = "Today’s points";
} else if (mode === "week") {
  subtitle.textContent = "Points from Monday to Sunday";
} else {
  subtitle.textContent = "All-time points";
}

  const scores = {};

  const weekStart = getMondayStart(new Date());
  const nextWeekStart = new Date(weekStart);
  nextWeekStart.setDate(nextWeekStart.getDate() + 7);
  const todayStart = new Date();
todayStart.setHours(0,0,0,0);
const tomorrowStart = new Date(todayStart);
tomorrowStart.setDate(tomorrowStart.getDate() + 1);


  // Start at 1 to skip header row
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];

    const player = String(r[headerIndex["Player"]] || "").trim();
    if (!player) continue;

    const total = Number(r[headerIndex["DailyTotal"]]) || 0;

   if (mode === "day" || mode === "week") {
  const entryDate = parseLocalDate(r[headerIndex["Date"]]);
  if (!entryDate) continue;

  if (mode === "day") {
    if (entryDate < todayStart || entryDate >= tomorrowStart) continue;
  }

  if (mode === "week") {
    if (entryDate < weekStart || entryDate >= nextWeekStart) continue;
  }
}


    scores[player] = (scores[player] || 0) + total;
  }

  const ranked = Object.entries(scores).sort((a,b) => b[1] - a[1]);

  const list = document.getElementById("list");
  list.innerHTML = "";

  if (ranked.length === 0) {
    list.innerHTML = "<p style='text-align:center;color:#666;'>No entries yet for this view.</p>";
    return;
  }

  ranked.forEach(([name, score], idx) => {
    const div = document.createElement("div");
    div.className = "card";
    div.onclick = () => openHistory(name);
    div.innerHTML = `<strong>#${idx+1} ${escapeHtml(name)}</strong><span>${score}</span>`;
    list.appendChild(div);
  });
}

function init() {
  fetch(SCRIPT_URL)
    .then(r => r.json())
    .then(data => {
      rows = data;

      const headers = rows[0] || [];
      headerIndex = {};
      headers.forEach((h, i) => headerIndex[String(h).trim()] = i);

      loadLeaderboard("day");
    })
    .catch(err => {
      console.error(err);
      const list = document.getElementById("list");
      if (list) list.innerHTML = "<p style='text-align:center;color:#666;'>Could not load data.</p>";
    });
}

function openHistory(playerName) {
  document.getElementById("modal").classList.add("open");
  document.getElementById("modalTitle").textContent = playerName + " — History";

  const body = document.getElementById("modalBody");
  body.innerHTML = "";

  // loop ALL rows, show only this player (no week/day filter — full history)
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    const player = String(r[headerIndex["Player"]] || "").trim();
    if (player !== playerName) continue;

    const dateVal = r[headerIndex["Date"]];
    const total = Number(r[headerIndex["DailyTotal"]]) || 0;

    const gym = Number(r[headerIndex["Gym"]]) === 1;
    const steps = Number(r[headerIndex["Steps"]]) === 1;
    const omad = Number(r[headerIndex["OMAD"]]) === 1;

    const entry = document.createElement("div");
    entry.className = "entry";

    entry.innerHTML = `
      <div>
        <div><strong>${escapeHtml(dateVal)}</strong></div>
        <div class="pills">
          ${gym ? `<span class="pill">Gym</span>` : ""}
          ${steps ? `<span class="pill">10k</span>` : ""}
          ${omad ? `<span class="pill">OMAD</span>` : ""}
        </div>
      </div>
      <div class="pts">${total}</div>
    `;

    body.appendChild(entry);
  }

  if (body.innerHTML.trim() === "") {
    body.innerHTML = "<p style='text-align:center;color:#666;'>No entries for this player yet.</p>";
  }
}

function closeModal() {
  document.getElementById("modal").classList.remove("open");
}


document.addEventListener("click", (e) => {
  const modal = document.getElementById("modal");
  if (!modal.classList.contains("open")) return;
  if (e.target === modal) closeModal();
});

  
window.addEventListener("load", init);
</script>


</body>
</html>
