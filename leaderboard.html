<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Momentum – Leaderboard</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #fafafa;
  color: #111;
max-width: 520px;
margin: 0 auto;
padding: 20px;

}

h1 {
  text-align: center;
}

.toggle {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.toggle button {
  flex: 1;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ddd;
  background: white;
  cursor: pointer;
}

.toggle button.active {
  background: #000;
  color: white;
}

.card {
  background: white;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;

  cursor: pointer;
  transition: transform 0.08s ease, box-shadow 0.12s ease;
}
  .card:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.06);
}

.badge {
  font-weight: 700;
  margin-right: 8px;
}

.fade-in {
  animation: fadeIn 160ms ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(3px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Modal */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
  z-index: 9999;
}

.modal.open { display: flex; }

.modal-box {
  width: 100%;
  max-width: 520px;
  background: #fff;
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 18px 60px rgba(0,0,0,0.18);
}

.modal-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 10px;
}

.modal-title {
  font-size: 18px;
  font-weight: 800;
}

.modal-close {
  border: 1px solid #ddd;
  background: #fff;
  border-radius: 10px;
  padding: 8px 10px;
  cursor: pointer;
}

.modal-close:hover { background: #f5f5f5; }

.history {
  max-height: 60vh;
  overflow: auto;
  padding-right: 4px;
}

.entry {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #eee;
  margin-bottom: 8px;
}

.entry .meta { color: #666; font-size: 13px; }
.entry .pts  { font-weight: 800; }

.pills {
  display: flex;
  gap: 6px;
  margin-top: 4px;
  flex-wrap: wrap;
}

.pill {
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid #eee;
  background: #fafafa;
}

.pill.bonus {
  font-weight: 800;
}

.pill.nobonus {
  color: #666;
}

@media (max-width: 520px) {
  body {
    max-width: 100%;
    padding: 16px;
  }
}

  
</style>
</head>

<body>

<h1>Leaderboard</h1>
<p style="text-align:center;margin-top=-10px;">
  <a href="index.html">← Back to Check-In</a>
</p>

<div class="toggle">
  <button id="dayBtn" onclick="loadLeaderboard('day')">Today</button>
  <button id="weekBtn" class="active" onclick="loadLeaderboard('week')">This Week</button>
  <button id="allBtn" onclick="loadLeaderboard('all')">All Time</button>
</div>
<p id="subtitle" style="text-align:center;color:#666;margin-top:-4px;"></p>

<div id="list"></div>

  <!-- Player History Modal -->
<div id="modal" class="modal">
  <div class="modal-box fade-in">
    <div class="modal-head">
      <div id="modalTitle" class="modal-title">Player History</div>
      <button class="modal-close" onclick="closeModal()">Close</button>
    </div>
    <div id="modalBody" class="history"></div>
  </div>
</div>

<script>

function formatDatePretty(value) {
  const d = parseLocalDate(value);
  if (!d) return escapeHtml(value);

  return d.toLocaleDateString(undefined, {
    weekday: "short",
    month: "short",
    day: "numeric",
    year: "numeric"
  });
}

  
let rows = [];
let headerIndex = {};

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwgLfgAXom6gv4L3yC6wjhrKzzhRsDtJI0Gbez8PB7Byg0RVvSczzhW0wYbDb-4A_mu3A/exec"; // same one you use for saving

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

function getMondayStart(d) {
  const x = new Date(d);
  x.setHours(0,0,0,0);
  const day = x.getDay(); // Sun=0
  const diff = (day === 0 ? -6 : 1 - day);
  x.setDate(x.getDate() + diff);
  return x;
}

function sameDay(a, b) {
  return a.getFullYear() === b.getFullYear()
    && a.getMonth() === b.getMonth()
    && a.getDate() === b.getDate();
}

function inRange(d, start, end) {
  return d >= start && d < end;
}

  
function parseLocalDate(value) {
  if (!value) return null;

  // If Apps Script returned a Date object
  if (Object.prototype.toString.call(value) === "[object Date]" && !isNaN(value.getTime())) {
    return new Date(value.getFullYear(), value.getMonth(), value.getDate(), 0, 0, 0, 0);
  }

  // If it's an ISO string like "2025-12-22T05:00:00.000Z"
  // Treat it as a DATE (YYYY-MM-DD) to avoid timezone day-shift.
  if (typeof value === "string") {
    const iso = /^(\d{4})-(\d{2})-(\d{2})T/.exec(value);
    if (iso) {
      return new Date(Number(iso[1]), Number(iso[2]) - 1, Number(iso[3]), 0, 0, 0, 0);
    }
  }

  
  // If it's a string like "Fri Dec 12 2025 ..."
  const d1 = new Date(value);
  if (!isNaN(d1.getTime())) {
    return new Date(d1.getFullYear(), d1.getMonth(), d1.getDate(), 0, 0, 0, 0);
  }

  // If it's "YYYY-MM-DD"
  const s = String(value).trim();
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
  if (!m) return null;
  return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]), 0, 0, 0, 0);
}

function computeWeeklyBonusForPlayer(weekStart, nextWeekStart, playerName) {
  // count distinct days in the week where they did OMAD and Gym
  const omadDays = new Set();
  const gymDays = new Set();

  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    const player = String(r[headerIndex["Player"]] || "").trim();
    if (player !== playerName) continue;

    const entryDate = parseLocalDate(r[headerIndex["Date"]]);
    if (!entryDate) continue;
    if (!inRange(entryDate, weekStart, nextWeekStart)) continue;

    const dateKey = entryDate.toISOString().slice(0, 10); // YYYY-MM-DD stable key

    const omad = Number(r[headerIndex["OMAD"]]) || 0;
    const gym  = Number(r[headerIndex["Gym"]]) || 0;

    if (omad === 1) omadDays.add(dateKey);
    if (gym === 1)  gymDays.add(dateKey);
  }

  let bonus = 0;

  // your rules: OMAD >= 6 days => +5, Gym >= 3 days => +6
  if (omadDays.size >= 6) bonus += 5;
  if (gymDays.size  >= 3) bonus += 6;

  return bonus;
}

  
function loadLeaderboard(mode) {
  document.getElementById("weekBtn").classList.toggle("active", mode === "week");
  document.getElementById("allBtn").classList.toggle("active", mode === "all");
  document.getElementById("dayBtn").classList.toggle("active", mode === "day");
const subtitle = document.getElementById("subtitle");

if (mode === "day") {
  subtitle.textContent = "Today’s points";
} else if (mode === "week") {
  subtitle.textContent = "Points from Monday to Sunday";
} else {
  subtitle.textContent = "All-time points";
}

  // --- weekly bonus settings (edit here) ---
  const BONUS_OMAD_DAYS = 6;   // e.g. 6/7 days
  const BONUS_OMAD_PTS  = 5;
  const BONUS_GYM_DAYS  = 3;   // e.g. gym >= 3 days
  const BONUS_GYM_PTS   = 6;

  const baseScores = {};                 // player -> summed DailyTotal
  const weeklyDays = {};                 // player -> { omad:Set, gym:Set }

  const weekStart = getMondayStart(new Date());
  const nextWeekStart = new Date(weekStart);
  nextWeekStart.setDate(nextWeekStart.getDate() + 7);

  const todayStart = new Date();
  todayStart.setHours(0,0,0,0);
  const tomorrowStart = new Date(todayStart);
  tomorrowStart.setDate(tomorrowStart.getDate() + 1);

  // Start at 1 to skip header row
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];

    const player = String(r[headerIndex["Player"]] || "").trim();
    if (!player) continue;

    const total = Number(r[headerIndex["DailyTotal"]]) || 0;

    // date filtering for day/week modes
let entryDate = null;

if (mode === "day") {
  const tsVal =
    r[headerIndex["Timestamp"]] ??
    r[headerIndex["Time"]] ??
    r[0]; // fallback: first column is usually timestamp

  const d = new Date(tsVal);
  if (isNaN(d.getTime())) continue;

  // IMPORTANT: turn timestamp into LOCAL date at 00:00
  entryDate = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0);

  if (entryDate < todayStart || entryDate >= tomorrowStart) continue;
}

if (mode === "week") {
  // Keep using Date for weekly grouping
  entryDate = parseLocalDate(r[headerIndex["Date"]]);
  if (!entryDate) continue;

  if (entryDate < weekStart || entryDate >= nextWeekStart) continue;
}

    // base score always sums DailyTotal
    baseScores[player] = (baseScores[player] || 0) + total;

    // track weekly completion days (ONLY for weekly bonuses)
    if (mode === "week") {
      if (!weeklyDays[player]) {
        weeklyDays[player] = { omad: new Set(), gym: new Set() };
      }

      const dayKey = entryDate.toISOString().slice(0,10); // yyyy-mm-dd stable key

      const gym  = Number(r[headerIndex["Gym"]]) === 1;
      const omad = Number(r[headerIndex["OMAD"]]) === 1;

      if (gym)  weeklyDays[player].gym.add(dayKey);
      if (omad) weeklyDays[player].omad.add(dayKey);
    }
  }

    // compute bonuses
  const bonusByPlayer = {};
  if (mode === "week") {
    for (const [player, sets] of Object.entries(weeklyDays)) {
      let bonus = 0;
      if (sets.omad.size >= BONUS_OMAD_DAYS) bonus += BONUS_OMAD_PTS;
      if (sets.gym.size  >= BONUS_GYM_DAYS)  bonus += BONUS_GYM_PTS;
      bonusByPlayer[player] = bonus;
    }
  } else if (mode === "all") {
    const weeksByPlayer = {};
    for (let i = 1; i < rows.length; i++) {
      const r = rows[i];
      const player = String(r[headerIndex["Player"]] || "").trim();
      if (!player) continue;

      const entryDate = parseLocalDate(r[headerIndex["Date"]]);
      if (!entryDate) continue;

      const weekStart = getMondayStart(entryDate);
      const weekKey = weekStart.toISOString().slice(0, 10);
      if (!weeksByPlayer[player]) weeksByPlayer[player] = new Set();
      weeksByPlayer[player].add(weekKey);
    }

    for (const [player, weekKeys] of Object.entries(weeksByPlayer)) {
      let totalBonus = 0;
      for (const weekKey of weekKeys) {
        const weekStart = new Date(weekKey + "T00:00:00");
        const nextWeekStart = new Date(weekStart);
        nextWeekStart.setDate(nextWeekStart.getDate() + 7);
        totalBonus += computeWeeklyBonusForPlayer(weekStart, nextWeekStart, player);
      }
      bonusByPlayer[player] = totalBonus;
    }
  }

  // ranked rows: include score + bonus so we can display it
  const ranked = Object.entries(baseScores)
    .map(([name, base]) => {
      const bonus = (mode === "week" || mode === "all") ? (bonusByPlayer[name] || 0) : 0;
      return { name, base, bonus, score: base + bonus };
    })
    .sort((a, b) => b.score - a.score);

  const list = document.getElementById("list");
  list.innerHTML = "";

  if (ranked.length === 0) {
    list.innerHTML = "<p style='text-align:center;color:#666;'>No entries yet for this view.</p>";
    return;
  }

ranked.forEach((row, idx) => {
  const div = document.createElement("div");
  div.className = "card";
  div.onclick = () => openHistory(row.name);

  const bonusText =
  ((mode === "week" || mode === "all") && row.bonus > 0)
    ? `<span style="color:#666;font-weight:600;"> (+${row.bonus})</span>`
    : "";

  div.innerHTML = `
    <strong>#${idx + 1} ${escapeHtml(row.name)}</strong>
    <span>${row.score}${bonusText}</span>
  `;
  list.appendChild(div);
});

}

function init() {
  fetch(SCRIPT_URL)
    .then(r => r.json())
    .then(data => {
      rows = data;

      const headers = rows[0] || [];
      headerIndex = {};
      headers.forEach((h, i) => headerIndex[String(h).trim()] = i);

      loadLeaderboard("day");
    })
    .catch(err => {
      console.error(err);
      const list = document.getElementById("list");
      if (list) list.innerHTML = "<p style='text-align:center;color:#666;'>Could not load data.</p>";
    });
}

function openHistory(playerName) {
  document.getElementById("modal").classList.add("open");
  document.getElementById("modalTitle").textContent = playerName + " — History";

  const body = document.getElementById("modalBody");
  body.innerHTML = "";

  // Cache bonus per week for this player so we don’t recompute for every entry
  const bonusCache = {}; // weekKey ("YYYY-MM-DD" Monday) -> bonus number

  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    const player = String(r[headerIndex["Player"]] || "").trim();
    if (player !== playerName) continue;

    // Use Timestamp (local date) to avoid timezone day-shift in History
const tsVal =
  r[headerIndex["Timestamp"]] ??
  r[headerIndex["Time"]] ??
  r[0]; // fallback: first column usually is timestamp

const d = new Date(tsVal);
const entryDate = isNaN(d.getTime())
  ? null
  : new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0);

    const total = Number(r[headerIndex["DailyTotal"]]) || 0;
    const gym      = Number(r[headerIndex["Gym"]]) === 1;
    const steps    = Number(r[headerIndex["Steps"]]) === 1;
    const omad     = Number(r[headerIndex["OMAD"]]) === 1;
    const calories = Number(r[headerIndex["Calories"]]) === 1;
    const steps10k = Number(r[headerIndex["Steps10k"]]) === 1;
    const steps6k  = Number(r[headerIndex["Steps6k"]]) === 1;
    const nocarb   = Number(r[headerIndex["NoCarb"]]) === 1;

    // Build pills
    const pills = [];
    if (gym) pills.push("Gym");
    if (steps) pills.push("Cardio");
    if (omad) pills.push("Diet");
    if (calories) pills.push("Calorie tracking");
    if (steps10k) pills.push("10k steps");
    if (steps6k) pills.push("6k steps");
    if (nocarb) pills.push("No carb day");

    // Weekly bonus pill (based on the week this entry falls in)
    let weeklyBonus = 0;
    if (entryDate) {
      const weekStart = getMondayStart(entryDate);
      const nextWeekStart = new Date(weekStart);
      nextWeekStart.setDate(nextWeekStart.getDate() + 7);

      const weekKey = weekStart.toISOString().slice(0, 10);
      if (bonusCache[weekKey] === undefined) {
        bonusCache[weekKey] = computeWeeklyBonusForPlayer(weekStart, nextWeekStart, playerName);
      }
      weeklyBonus = bonusCache[weekKey];
    }

    if (weeklyBonus > 0) pills.push(`Bonus +${weeklyBonus}`);
    else pills.push("No bonus");

    const pillsHtml = pills.map(p => {
      const cls = p.startsWith("Bonus") ? "pill bonus" : (p === "No bonus" ? "pill nobonus" : "pill");
      return `<span class="${cls}">${escapeHtml(p)}</span>`;
    }).join("");

    const entry = document.createElement("div");
    entry.className = "entry";

    entry.innerHTML = `
      <div>
        <div><strong>${formatDatePretty(entryDate || tsVal)}</strong></div>
        <div class="pills">${pillsHtml}</div>
      </div>
      <div class="pts">${total}</div>
    `;

    body.appendChild(entry);
  }

  if (body.innerHTML.trim() === "") {
    body.innerHTML = "<p style='text-align:center;color:#666;'>No entries for this player yet.</p>";
  }
}

function closeModal() {
  document.getElementById("modal").classList.remove("open");
}

document.addEventListener("click", (e) => {
  const modal = document.getElementById("modal");
  if (!modal.classList.contains("open")) return;
  if (e.target === modal) closeModal();
});

  
window.addEventListener("load", init);
</script>
</body>
</html>
