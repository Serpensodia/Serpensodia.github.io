<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Momentum â€“ Leaderboard</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #fafafa;
  color: #111;
  max-width: 420px;
  margin: auto;
  padding: 20px;
}

h1 {
  text-align: center;
}

.toggle {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.toggle button {
  flex: 1;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ddd;
  background: white;
  cursor: pointer;
}

.toggle button.active {
  background: #000;
  color: white;
}

.card {
  background: white;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
}
</style>
</head>

<body>

<h1>Leaderboard</h1>

<div class="toggle">
  <button id="weekBtn" class="active" onclick="loadLeaderboard('week')">This Week</button>
  <button id="allBtn" onclick="loadLeaderboard('all')">All Time</button>
</div>

<div id="list"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZRRiqnFI0e_qMWqHt3GyFYioZV1Li-cJOYecEd1tRmALgZ-LQ73RVu_VYicyXLr2KNg/exec";

let rawData = [];

fetch(SCRIPT_URL)
  .then(res => res.json())
  .then(data => {
    // data should be a 2D array: [ [header...], [row...], [row...] ]
    rawData = data.slice(1).filter(r => r && r.length >= 8 && String(r[3] || "").trim() !== "");
    renderDebug(data.length, rawData.length);
    loadLeaderboard('week');
  })
  .catch(err => {
    document.getElementById("list").innerHTML = "<p>Could not load data.</p>";
    console.error(err);
  });

function renderDebug(totalRows, usableRows) {
  const p = document.createElement("p");
  p.style.textAlign = "center";
  p.style.color = "#666";
  p.style.marginTop = "-6px";
  p.textContent = `Loaded ${usableRows} entries (${totalRows} rows including header).`;
  document.body.insertBefore(p, document.getElementById("list"));
}

function loadLeaderboard(mode) {
  document.getElementById("weekBtn").classList.toggle("active", mode === 'week');
  document.getElementById("allBtn").classList.toggle("active", mode === 'all');

  const scores = {};
  const currentWeek = getWeek(new Date());

  rawData.forEach(row => {
    // Expected columns:
    // 0 Timestamp | 1 Date | 2 Week | 3 Player | 4 Gym | 5 Steps | 6 OMAD | 7 DailyTotal
    const weekVal = Number(row[2]);       // force numeric
    const player  = String(row[3]).trim();
    const total   = Number(row[7]) || 0;

    if (!player) return;
    if (mode === 'week' && weekVal !== currentWeek) return;

    scores[player] = (scores[player] || 0) + total;
  });

  const ranked = Object.entries(scores).sort((a,b) => b[1] - a[1]);

  const list = document.getElementById("list");
  list.innerHTML = "";

  if (ranked.length === 0) {
    list.innerHTML = "<p style='text-align:center;color:#666;'>No entries yet for this view.</p>";
    return;
  }

  ranked.forEach(([name, score], i) => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<strong>#${i+1} ${escapeHtml(name)}</strong><span>${score}</span>`;
    list.appendChild(div);
  });
}

function getWeek(date) {
  const d = new Date(date);
  d.setHours(0,0,0);
  d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
  const week1 = new Date(d.getFullYear(),0,4);
  return 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
}

function escapeHtml(s) {
  return s.replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
</script>

</body>
</html>
