<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Momentum – Leaderboard</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #fafafa;
  color: #111;
  max-width: 420px;
  margin: auto;
  padding: 20px;
}

h1 {
  text-align: center;
}

.toggle {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.toggle button {
  flex: 1;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ddd;
  background: white;
  cursor: pointer;
}

.toggle button.active {
  background: #000;
  color: white;
}

.card {
  background: white;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
}
</style>
</head>

<body>

<h1>Leaderboard</h1>
<p style="text-align:center;margin-top:-10px;">
  <a href="index.html">← Back to Check-In</a>
</p>

<div class="toggle">
  <button id="weekBtn" class="active" onclick="loadLeaderboard('week')">This Week</button>
  <button id="allBtn" onclick="loadLeaderboard('all')">All Time</button>
</div>

<div id="list"></div>
<script>
let rows = [];
let headerIndex = {};

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzvi4M8O6393Lzif6_XyzikHnLr996ynxG3mIcG9-CITWa8hbKeuK-G0MhjVJFxzenkUQ/exec"; // same one you use for saving

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

function getMondayStart(d) {
  const x = new Date(d);
  x.setHours(0,0,0,0);
  const day = x.getDay(); // Sun=0
  const diff = (day === 0 ? -6 : 1 - day);
  x.setDate(x.getDate() + diff);
  return x;
}

function parseLocalDate(value) {
  if (!value) return null;

  // If Apps Script returned a Date object
  if (Object.prototype.toString.call(value) === "[object Date]" && !isNaN(value.getTime())) {
    return new Date(value.getFullYear(), value.getMonth(), value.getDate(), 0, 0, 0, 0);
  }

  // If it's a string like "Fri Dec 12 2025 ..."
  const d1 = new Date(value);
  if (!isNaN(d1.getTime())) {
    return new Date(d1.getFullYear(), d1.getMonth(), d1.getDate(), 0, 0, 0, 0);
  }

  // If it's "YYYY-MM-DD"
  const s = String(value).trim();
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
  if (!m) return null;
  return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]), 0, 0, 0, 0);
}

function loadLeaderboard(mode) {
  document.getElementById("weekBtn").classList.toggle("active", mode === "week");
  document.getElementById("allBtn").classList.toggle("active", mode === "all");

  const scores = {};

  const weekStart = getMondayStart(new Date());
  const nextWeekStart = new Date(weekStart);
  nextWeekStart.setDate(nextWeekStart.getDate() + 7);

  // Start at 1 to skip header row
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];

    const player = String(r[headerIndex["Player"]] || "").trim();
    if (!player) continue;

    const total = Number(r[headerIndex["DailyTotal"]]) || 0;

    if (mode === "week") {
      const entryDate = parseLocalDate(r[headerIndex["Date"]]);
      if (!entryDate) continue;
      if (entryDate < weekStart || entryDate >= nextWeekStart) continue;
    }

    scores[player] = (scores[player] || 0) + total;
  }

  const ranked = Object.entries(scores).sort((a,b) => b[1] - a[1]);

  const list = document.getElementById("list");
  list.innerHTML = "";

  if (ranked.length === 0) {
    list.innerHTML = "<p style='text-align:center;color:#666;'>No entries yet for this view.</p>";
    return;
  }

  ranked.forEach(([name, score], idx) => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<strong>#${idx+1} ${escapeHtml(name)}</strong><span>${score}</span>`;
    list.appendChild(div);
  });
}

function init() {
  fetch(SCRIPT_URL)
    .then(r => r.json())
    .then(data => {
      rows = data;

      const headers = rows[0] || [];
      headerIndex = {};
      headers.forEach((h, i) => headerIndex[String(h).trim()] = i);

      loadLeaderboard("week");
    })
    .catch(err => {
      console.error(err);
      const list = document.getElementById("list");
      if (list) list.innerHTML = "<p style='text-align:center;color:#666;'>Could not load data.</p>";
    });
}

window.addEventListener("load", init);
</script>


</body>
</html>
