<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Momentum â€“ Leaderboard</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #fafafa;
  color: #111;
  max-width: 420px;
  margin: auto;
  padding: 20px;
}

h1 {
  text-align: center;
}

.toggle {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.toggle button {
  flex: 1;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ddd;
  background: white;
  cursor: pointer;
}

.toggle button.active {
  background: #000;
  color: white;
}

.card {
  background: white;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
}
</style>
</head>

<body>

<h1>Leaderboard</h1>

<div class="toggle">
  <button id="weekBtn" class="active" onclick="loadLeaderboard('week')">This Week</button>
  <button id="allBtn" onclick="loadLeaderboard('all')">All Time</button>
</div>

<div id="list"></div>
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzvi4M8O6393Lzif6_XyzikHnLr996ynxG3mIcG9-CITWa8hbKeuK-G0MhjVJFxzenkUQ/exec";

let rows = [];
let headerIndex = {};

fetch(SCRIPT_URL)
  .then(res => res.json())
  .then(data => {
    if (!data || data.length < 2) {
      showMsg("No data returned from the sheet yet.");
      return;
    }

    // Build header -> column index map
    const headers = data[0].map(h => String(h).trim());
    headers.forEach((h, i) => headerIndex[h] = i);

    // REQUIRED columns
    const need = ["Player", "Week", "DailyTotal"];
    const missing = need.filter(k => headerIndex[k] === undefined);
    if (missing.length) {
      showMsg("Missing columns: " + missing.join(", "));
      console.log("Headers found:", headers);
      return;
    }

    rows = data.slice(1).filter(r => r && r.length);

    // small debug line so you know it loaded
    const debug = document.createElement("p");
    debug.style.textAlign = "center";
    debug.style.color = "#666";
    debug.textContent = `Loaded ${rows.length} entries.`;
    document.body.insertBefore(debug, document.getElementById("list"));

    loadLeaderboard("week");
  })
  .catch(err => {
    showMsg("Could not load data (check SCRIPT_URL / deployment access).");
    console.error(err);
  });

function loadLeaderboard(mode) {
  document.getElementById("weekBtn").classList.toggle("active", mode === "week");
  document.getElementById("allBtn").classList.toggle("active", mode === "all");

  const scores = {};
  const currentWeek = getWeek(new Date());

  for (const r of rows) {
    const player = String(r[headerIndex["Player"]] || "").trim();
    const week = Number(r[headerIndex["Week"]]);
    const total = Number(r[headerIndex["DailyTotal"]]) || 0;

    if (!player) continue;
    if (mode === "week" && week !== currentWeek) continue;

    scores[player] = (scores[player] || 0) + total;
  }

  const ranked = Object.entries(scores).sort((a,b) => b[1] - a[1]);

  const list = document.getElementById("list");
  list.innerHTML = "";

  if (ranked.length === 0) {
    list.innerHTML = "<p style='text-align:center;color:#666;'>No entries yet for this view.</p>";
    return;
  }

  for (let i = 0; i < ranked.length; i++) {
    const [name, score] = ranked[i];
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<strong>#${i+1} ${escapeHtml(name)}</strong><span>${score}</span>`;
    list.appendChild(div);
  }
}

function showMsg(msg) {
  document.getElementById("list").innerHTML =
    `<p style="text-align:center;color:#666;">${escapeHtml(msg)}</p>`;
}

function getWeek(date) {
  const d = new Date(date);
  d.setHours(0,0,0);
  d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
  const week1 = new Date(d.getFullYear(),0,4);
  return 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
</script>


</body>
</html>
